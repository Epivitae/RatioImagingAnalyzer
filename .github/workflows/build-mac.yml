name: Build macOS App

on:
  push:
    branches: [ "main", "master" ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip'

    - name: Install dependencies
      # 注意：假设 requirements.txt 还在项目根目录
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        brew install create-dmg

    - name: Extract Version
      id: get_version
      run: |
        VERSION=$(python3 -c "import re; print(re.search(r'__version__\s*=\s*[\"\']([^\"\']+)[\"\']', open('src/ria_gui/_version.py').read()).group(1))")
        echo "Detected Version: $VERSION"
        echo "APP_VERSION=$VERSION" >> $GITHUB_ENV

    - name: Build with PyInstaller
      # ✅ 核心修改 1: 指定工作目录，自动进入 src/ria_gui
      working-directory: src/ria_gui
      run: |
        echo "Current directory: $(pwd)"
        
        # ✅ 核心修改 2: 使用相对路径 (和本地命令保持一致)
        # 移除了 --paths 和本地模块的 hidden-import (进入目录后 PyInstaller 通常能自动发现它们)
        # 保留了必要的第三方库 hidden-import
        
        pyinstaller --noconfirm --onedir --windowed --clean \
          --name "RIA_${{ env.APP_VERSION }}" \
          --icon "assets/app.icns" \
          --add-data "assets:assets" \
          --hidden-import "cv2" \
          --hidden-import "numpy" \
          --hidden-import "matplotlib" \
          --hidden-import "tkinter" \
          --hidden-import "PIL" \
          --hidden-import "tifffile" \
          main.py

    - name: Sign App (Ad-hoc)
      run: |
        # ✅ 路径修正: dist 现在位于 src/ria_gui/dist
        APP_PATH="src/ria_gui/dist/RIA_${{ env.APP_VERSION }}.app"
        
        echo "Signing app at: $APP_PATH"
        codesign --remove-signature "$APP_PATH" || true
        codesign --force --deep --sign - "$APP_PATH"

    - name: Create DMG Installer
      run: |
        # 准备目录
        mkdir -p dist/dmg
        rm -f "dist/dmg/RIA_${{ env.APP_VERSION }}_macOS.dmg"

        # 定义路径变量方便阅读
        APP_SOURCE="src/ria_gui/dist/RIA_${{ env.APP_VERSION }}.app"
        DMG_OUTPUT="dist/dmg/RIA_${{ env.APP_VERSION }}_macOS.dmg"
        ICON_SOURCE="src/ria_gui/assets/app.icns"

        # ✅ 路径修正: create-dmg 的输入源改为 src/ria_gui 下的路径
        create-dmg \
          --volname "RIA Installer" \
          --volicon "$ICON_SOURCE" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "RIA_${{ env.APP_VERSION }}.app" 200 190 \
          --hide-extension "RIA_${{ env.APP_VERSION }}.app" \
          --app-drop-link 400 185 \
          "$DMG_OUTPUT" \
          "$APP_SOURCE"

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: RIA-macOS-${{ env.APP_VERSION }}
        path: dist/dmg/*.dmg
        if-no-files-found: error