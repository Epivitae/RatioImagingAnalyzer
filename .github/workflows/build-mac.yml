## input fold not right
name: Build macOS App

on:
  push:
    branches: [ "main", "master" ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip'

    - name: Install dependencies
      # 依赖安装依然在根目录进行，因为 requirements.txt 通常在根目录
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        brew install create-dmg

    - name: Extract Version
      id: get_version
      run: |
        # 这里用完整路径读取 version，确保不出错
        VERSION=$(python3 -c "import re; print(re.search(r'__version__\s*=\s*[\"\']([^\"\']+)[\"\']', open('src/ria_gui/_version.py').read()).group(1))")
        echo "Detected Version: $VERSION"
        echo "APP_VERSION=$VERSION" >> $GITHUB_ENV

    - name: Build with PyInstaller
      # ✅ 【核心修改】这里指定工作目录，模拟你本地的操作
      working-directory: src/ria_gui
      run: |
        echo "Current directory: $(pwd)"
        
        # ✅ 因为进入了 src/ria_gui，所以下面的路径都要改成相对路径（去掉 src/ria_gui 前缀）
        # ✅ 这完全复制了你本地成功的命令
        
        pyinstaller --noconfirm --onedir --windowed --clean \
          --name "RIA_${{ env.APP_VERSION }}" \
          --icon "assets/app.icns" \
          --add-data "assets:assets" \
          --hidden-import "cv2" \
          --hidden-import "numpy" \
          --hidden-import "matplotlib" \
          --hidden-import "tkinter" \
          --hidden-import "PIL" \
          --hidden-import "tifffile" \
          main.py

    - name: Sign App (Ad-hoc)
      run: |
        # ✅ 因为打包是在 src/ria_gui 下进行的，PyInstaller 会把 dist 生成在 src/ria_gui/dist
        APP_PATH="src/ria_gui/dist/RIA_${{ env.APP_VERSION }}.app"
        
        echo "Signing app at: $APP_PATH"
        codesign --remove-signature "$APP_PATH" || true
        codesign --force --deep --sign - "$APP_PATH"

    - name: Create DMG Installer
      run: |
        # 在根目录创建存放 DMG 的文件夹
        mkdir -p dist/dmg
        rm -f "dist/dmg/RIA_${{ env.APP_VERSION }}_macOS.dmg"

        # ✅ 修正源文件路径，指向 src/ria_gui/dist
        APP_SOURCE="src/ria_gui/dist/RIA_${{ env.APP_VERSION }}.app"
        DMG_OUTPUT="dist/dmg/RIA_${{ env.APP_VERSION }}_macOS.dmg"
        ICON_SOURCE="src/ria_gui/assets/app.icns"

        create-dmg \
          --volname "RIA Installer" \
          --volicon "$ICON_SOURCE" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "RIA_${{ env.APP_VERSION }}.app" 200 190 \
          --hide-extension "RIA_${{ env.APP_VERSION }}.app" \
          --app-drop-link 400 185 \
          "$DMG_OUTPUT" \
          "$APP_SOURCE"

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: RIA-macOS-${{ env.APP_VERSION }}
        # 上传根目录下的 dist/dmg
        path: dist/dmg/*.dmg