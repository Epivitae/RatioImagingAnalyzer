name: Build macOS App

# 触发机制：
# 1. 当发布新的 Release (published) 时自动触发
# 2. 允许手动点击按钮触发 (workflow_dispatch)，方便开发测试
on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-mac:
    runs-on: macos-latest # 使用最新的 macOS 环境 (Apple Silicon)
    
    steps:
      # --- 1. 拉取代码 ---
      - name: Checkout code
        uses: actions/checkout@v4

      # --- 2. 设置 Python 环境 ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      # --- 3. 安装依赖 (关键瘦身步骤) ---
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          
          # 【瘦身核心】：处理 requirements.txt
          # 将 opencv-python 替换为无 GUI 的轻量版 opencv-python-headless
          if [ -f requirements.txt ]; then
            echo "Optimizing requirements.txt for macOS..."
            # 使用 sed 替换 (macOS sed 语法需要 -i '')
            sed -i '' 's/opencv-python/opencv-python-headless/g' requirements.txt
            sed -i '' 's/opencv-contrib-python/opencv-python-headless/g' requirements.txt
            
            # 安装修改后的依赖
            pip install -r requirements.txt
          else
            # 如果没有 requirements.txt，直接安装
            pip install opencv-python-headless numpy matplotlib scipy tifffile
          fi
          
          # 再次强制安装 headless 以防万一
          pip install opencv-python-headless
          
          # 安装打包工具
          pip install pyinstaller

      # --- 4. 同步版本号 ---
      - name: Sync Version
        run: |
          TAG_NAME=${{ github.ref_name }}
          echo "Building version: $TAG_NAME"
          
          if [ -f "src/ria_gui/_version.py" ]; then
            sed -i '' "s/__version__\s*=\s*[\"'].*[\"']/__version__ = \"$TAG_NAME\"/" src/ria_gui/_version.py
          fi

      # --- 5. 执行打包 (PyInstaller) ---
      - name: Build with PyInstaller
        run: |
          APP_NAME="RIA_Liya_${{ github.ref_name }}_macOS"
          
          # --exclude-module: 排除测试库和无用模块以减小体积
          pyinstaller --noconsole --windowed --name "$APP_NAME" \
            --add-data "src/ria_gui/assets:assets" \
            --icon "src/ria_gui/assets/app.icns" \
            --paths "src/ria_gui" \
            --exclude-module matplotlib.tests \
            --exclude-module numpy.random._examples \
            --exclude-module tkinter.test \
            --exclude-module unittest \
            --exclude-module pydoc \
            --exclude-module lib2to3 \
            src/ria_gui/main.py

      # --- 6. 压缩打包产物 ---
      - name: Package Application
        run: |
          cd dist
          APP_NAME="RIA_Liya_${{ github.ref_name }}_macOS"
          
          if [ -d "$APP_NAME.app" ]; then
            echo "Packaging $APP_NAME.app ..."
            # 使用 -r 递归压缩
            zip -r "$APP_NAME.zip" "$APP_NAME.app"
          else
            echo "Error: App build failed, directory not found."
            exit 1
          fi

      # --- 7. 上传到 Release (仅正式发布时) ---
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- 8. 上传测试产物 (Artifacts) ---
      # 无论手动还是自动触发都执行，方便你在 VS Code 插件里直接下载测试
      - name: Upload Artifact for Testing
        uses: actions/upload-artifact@v4
        with:
          name: macOS-App-Build
          path: dist/*.zip
          retention-days: 5