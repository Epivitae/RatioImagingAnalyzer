name: Build macOS App

on:
  push:
    branches: [ "main", "master" ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # 1. 安装 Python 依赖
        pip install -r requirements.txt
        pip install pyinstaller
        
        # 2. 通过 Homebrew 安装 create-dmg 工具 (关键修改)
        brew install create-dmg

    - name: Extract Version
      id: get_version
      run: |
        VERSION=$(python3 -c "import re; print(re.search(r'__version__\s*=\s*[\"\']([^\"\']+)[\"\']', open('src/ria_gui/_version.py').read()).group(1))")
        echo "Detected Version: $VERSION"
        echo "APP_VERSION=$VERSION" >> $GITHUB_ENV

    - name: Build with PyInstaller
      run: |
        pyinstaller --noconfirm --onedir --windowed --clean \
          --name "RIA_${{ env.APP_VERSION }}" \
          --icon "src/ria_gui/assets/app.icns" \
          --add-data "src/ria_gui/assets:assets" \
          --hidden-import "cv2" \
          --hidden-import "numpy" \
          --hidden-import "matplotlib" \
          --hidden-import "tkinter" \
          --hidden-import "PIL" \
          --hidden-import "tifffile" \
          src/ria_gui/main.py

    - name: Sign App (Ad-hoc)
      run: |
        # 移除可能存在的旧签名并重新进行 Ad-hoc 签名
        codesign --remove-signature "dist/RIA_${{ env.APP_VERSION }}.app" || true
        codesign --force --deep --sign - "dist/RIA_${{ env.APP_VERSION }}.app"

    - name: Create DMG Installer
      run: |
        mkdir -p dist/dmg
        
        # 确保目标 DMG 不存在
        rm -f "dist/dmg/RIA_${{ env.APP_VERSION }}_macOS.dmg"

        create-dmg \
          --volname "RIA Installer" \
          --volicon "src/ria_gui/assets/app.icns" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "RIA_${{ env.APP_VERSION }}.app" 200 190 \
          --hide-extension "RIA_${{ env.APP_VERSION }}.app" \
          --app-drop-link 400 185 \
          "dist/dmg/RIA_${{ env.APP_VERSION }}_macOS.dmg" \
          "dist/RIA_${{ env.APP_VERSION }}.app"

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: RIA-macOS-${{ env.APP_VERSION }}
        path: dist/dmg/*.dmg
        if-no-files-found: error