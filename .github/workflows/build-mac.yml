name: Build macOS App

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-mac:
    runs-on: macos-latest
    
    steps:
      # --- 1. 拉取代码 ---
      - name: Checkout code
        uses: actions/checkout@v4

      # --- 2. 设置 Python 环境 ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      # --- 3. 安装依赖 ---
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # 强制安装完整版依赖
          pip install opencv-python numpy matplotlib scipy tifffile requests
          pip install pyinstaller

      # --- 4. 临时修复代码 & 准备环境 ---
      - name: Patch Code and Prepare
        run: |
          # 【关键步骤】进入代码目录
          cd src/ria_gui
          echo "Current directory: $(pwd)"
          
          echo "Patching Windows-specific code..."
          # 修复 main.py (Windows AppID)
          sed -i '' 's/ctypes.windll/# ctypes.windll/g' main.py
          
          # 修复 gui.py (Windows Icon)
          sed -i '' 's/self.root.iconbitmap/pass # self.root.iconbitmap/g' gui.py
          
          # 修复 gui.py (强制暴露导入错误)
          # 我们把吞掉错误的 try...except 破坏掉，让它直接 crash 显示真实错误
          # 将 'except ImportError:' 替换为 'except ImportError: raise #' 
          # 这样如果 gui_components 导入失败，会直接抛出 ImportError 而不是后面的 NameError
          sed -i '' 's/except ImportError:/except ImportError: raise #/g' gui.py
          
          echo "Patching complete."

      # --- 5. 同步版本号 ---
      - name: Sync Version
        run: |
          cd src/ria_gui
          TAG_NAME=${{ github.ref_name }}
          echo "Building version: $TAG_NAME"
          
          if [ -f "_version.py" ]; then
            sed -i '' "s/__version__\s*=\s*[\"'].*[\"']/__version__ = \"$TAG_NAME\"/" _version.py
          fi

      # --- 6. 执行打包 (在子目录中运行) ---
      - name: Build with PyInstaller
        run: |
          # 【关键步骤】进入代码目录
          cd src/ria_gui
          
          APP_NAME="RIA_Liya_${{ github.ref_name }}_macOS"
          
          # 因为已经进入了目录，所有路径都不需要写 src/ria_gui 了
          # 这样 PyInstaller 会把当前目录下的所有 .py 文件视为同级，极大地减少导入错误
          
          pyinstaller --noconsole --windowed --name "$APP_NAME" \
            --argv-emulation \
            --target-arch arm64 \
            --add-data "assets:assets" \
            --icon "assets/app.icns" \
            --hidden-import "gui_components" \
            --hidden-import "processing" \
            --hidden-import "io_utils" \
            --hidden-import "components" \
            --hidden-import "constants" \
            --hidden-import "plot_window" \
            --hidden-import "PIL._tkinter_finder" \
            --exclude-module matplotlib.tests \
            --exclude-module numpy.random._examples \
            --exclude-module tkinter.test \
            --exclude-module unittest \
            --exclude-module pydoc \
            --exclude-module lib2to3 \
            main.py
            
          # 【关键步骤】把打包好的 App 移回项目根目录的 dist 文件夹
          # 这样后续的上传步骤才能找到它
          mkdir -p ../../dist
          mv "dist/$APP_NAME.app" ../../dist/

      # --- 7. 压缩打包产物 ---
      - name: Package Application
        run: |
          # 回到根目录的 dist
          cd dist
          APP_NAME="RIA_Liya_${{ github.ref_name }}_macOS"
          
          if [ -d "$APP_NAME.app" ]; then
            echo "Packaging $APP_NAME.app ..."
            zip -r "$APP_NAME.zip" "$APP_NAME.app"
          else
            echo "Error: App build failed, directory not found."
            ls -R
            exit 1
          fi

      # --- 8. 上传到 Release ---
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- 9. 上传测试产物 ---
      - name: Upload Artifact for Testing
        uses: actions/upload-artifact@v4
        with:
          name: macOS-App-Build
          path: dist/*.zip
          retention-days: 5